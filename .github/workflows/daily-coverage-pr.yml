name: Daily Coverage PR

on:
  schedule:
    - cron: '0 14 * * 1-5'  # 2 PM UTC, weekdays
  workflow_dispatch:

concurrency:
  group: daily-coverage
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  daily-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next day
        id: plan
        run: |
          # Read manifest and find the first day whose dest files don't exist on main
          MANIFEST=".github/daily-pool/manifest.json"
          if [ ! -f "$MANIFEST" ]; then
            echo "::error::Manifest not found at $MANIFEST"
            exit 1
          fi

          TOTAL_DAYS=$(jq '.days | length' "$MANIFEST")
          NEXT_DAY=""

          for i in $(seq 0 $((TOTAL_DAYS - 1))); do
            DAY_NUM=$(jq -r ".days[$i].day" "$MANIFEST")
            FIRST_DEST=$(jq -r ".days[$i].files[0].dest" "$MANIFEST")

            # Check if the first destination file already exists on main
            if ! git show "origin/main:$FIRST_DEST" &>/dev/null; then
              NEXT_DAY="$DAY_NUM"
              NEXT_INDEX="$i"
              break
            fi
          done

          if [ -z "$NEXT_DAY" ]; then
            echo "::notice::All days in the pool have been applied. Nothing to do."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PADDED_DAY=$(printf "%03d" "$NEXT_DAY")
          TITLE=$(jq -r ".days[$NEXT_INDEX].title" "$MANIFEST")
          DESCRIPTION=$(jq -r ".days[$NEXT_INDEX].description" "$MANIFEST")
          LANGUAGE=$(jq -r ".days[$NEXT_INDEX].language" "$MANIFEST")

          echo "day=$NEXT_DAY" >> "$GITHUB_OUTPUT"
          echo "padded_day=$PADDED_DAY" >> "$GITHUB_OUTPUT"
          echo "index=$NEXT_INDEX" >> "$GITHUB_OUTPUT"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "description=$DESCRIPTION" >> "$GITHUB_OUTPUT"
          echo "language=$LANGUAGE" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Merge previous daily PR
        if: steps.plan.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR=$(gh pr list --label "daily-coverage" --state open \
            --json number --jq '.[0].number // empty')

          if [ -n "$PR" ]; then
            echo "Merging previous daily PR #$PR..."
            gh pr merge "$PR" --squash --delete-branch \
              || echo "::warning::Could not merge PR #$PR — it may need manual attention"
          else
            echo "No previous daily PR found."
          fi

      - name: Apply bundle and open PR
        if: steps.plan.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DAY="${{ steps.plan.outputs.day }}"
          PADDED="${{ steps.plan.outputs.padded_day }}"
          TITLE="${{ steps.plan.outputs.title }}"
          DESCRIPTION="${{ steps.plan.outputs.description }}"
          LANGUAGE="${{ steps.plan.outputs.language }}"
          MANIFEST=".github/daily-pool/manifest.json"
          INDEX="${{ steps.plan.outputs.index }}"
          BRANCH="daily-coverage/day-${PADDED}"

          # Pull latest main after potential merge
          git fetch origin main
          git checkout main
          git pull origin main

          # Create the feature branch
          git checkout -b "$BRANCH"

          # Copy files from pool to destinations
          FILE_COUNT=$(jq ".days[$INDEX].files | length" "$MANIFEST")
          for j in $(seq 0 $((FILE_COUNT - 1))); do
            SRC=$(jq -r ".days[$INDEX].files[$j].src" "$MANIFEST")
            DEST=$(jq -r ".days[$INDEX].files[$j].dest" "$MANIFEST")

            # Ensure destination directory exists
            mkdir -p "$(dirname "$DEST")"
            cp "$SRC" "$DEST"
            echo "Copied $SRC -> $DEST"
          done

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "$TITLE

          $DESCRIPTION

          Day $DAY of the daily coverage pool ($LANGUAGE)."

          git push origin "$BRANCH"

          # Create the PR
          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "Day $DAY: $TITLE" \
            --label "daily-coverage" \
            --body "$(cat <<EOF
          ## Day $DAY — $TITLE

          **Language:** $LANGUAGE
          **Description:** $DESCRIPTION

          This PR was automatically generated by the daily coverage workflow.
          It adds well-tested utility code and includes some intentional code
          quality issues for Qlty to detect.

          ---
          *Part of the daily coverage pool (day $DAY/60)*
          EOF
          )"

          echo "::notice::Opened PR for day $DAY: $TITLE"
